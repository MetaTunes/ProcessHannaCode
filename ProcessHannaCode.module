<?php

/**
 * Process Hanna Code
 *
 * ProcessWire 2.x 
 * Copyright (C) 2013 by Ryan Cramer 
 * Licensed under GNU/GPL v2, see LICENSE.TXT
 * 
 * http://processwire.com
 *
 */

class ProcessHannaCode extends Process {

	/**
	 * Return information about this module (required)
	 *
	 */
	public static function getModuleInfo() {
		return array(
			'title' => 'Hanna Code', 
			'summary' => 'Easily insert any complex HTML, Javascript or PHP output in your ProcessWire content by creating your own Hanna code tags.',
			'version' => 8, 
			'permission' => 'hanna-code', 
			'requires' => 'TextformatterHannaCode'
			); 
	}

	/**
	 * The name that will be used for the page this module creates
	 *
	 */
	const pageName = 'hanna-code';

	/**
	 * Instance of TextformatterHannaCode
	 *
	 */
	protected $hanna = null;

	/**
	 * This is an optional initialization function called before any execute functions.
	 *
	 */
	public function init() {
		if(!$this->user->isSuperuser()) throw new WirePermissionException("This module may only be used by superuser"); 
		parent::init(); // required
		$data = $this->modules->getModuleConfigData('TextformatterHannaCode'); 
		$this->set('openTag', isset($data['openTag']) ? $data['openTag'] : TextformatterHannaCode::DEFAULT_OPEN_TAG); 
		$this->set('closeTag', isset($data['closeTag']) ? $data['closeTag'] : TextformatterHannaCode::DEFAULT_CLOSE_TAG); 
		$this->set('typeLabels', array(
			0 => $this->_('Text/HTML'),
			1 => $this->_('Javascript'),
			2 => $this->_('PHP')
			));
		$this->hanna = $this->modules->get('TextformatterHannaCode'); 
	}

	/**
	 * This function is executed when a page with your Process assigned is accessed. 
 	 *
	 */
	public function ___execute() {

		$table = $this->modules->get('MarkupAdminDataTable'); 
		$table->setEncodeEntities(false); 
		$table->headerRow(array(
			$this->_x('Name', 'list-table'), 
			$this->_x('Tag', 'list-table'), 
			$this->_x('Type', 'list-table'),
			$this->_x('Modified', 'list-table'),
			$this->_x('Accessed', 'list-table')
			)); 

		$typeLabels = $this->typeLabels;

		$sort = 'name';
		if($this->input->get->sort == '-modified') $sort = 'modified DESC';
		$result = $this->db->query("SELECT id, name, type, modified, accessed, code FROM hanna_code ORDER BY $sort"); 

		while($row = $result->fetch_row()) {
			list($id, $name, $type, $modified, $accessed, $code) = $row; 
			$attrs = '';
			foreach($this->hanna->extractDefaultCodeAttrs($code) as $attrName => $attrValue) {
				$attrs .= " $attrName=\"$attrValue\"";
			}

			if(preg_match('/[a-zA-Z0-9]$/', $this->openTag)) $name = " name=\"$name\"";
			$tag = $this->openTag . $name . $attrs . $this->closeTag; 

			if($type & TextformatterHannaCode::TYPE_NOT_CONSUMING) $type -= TextformatterHannaCode::TYPE_NOT_CONSUMING; 

			$table->row(array(
				wire('sanitizer')->entities($name) => "edit/?id=$id",
				"<code>" . wire('sanitizer')->entities($tag) . "</code>", 
				$typeLabels[$type],
				wireRelativeTimeStr($modified),
				wireRelativeTimeStr($accessed)
				)); 
		}

		if(!$result->num_rows) $this->message($this->_('No Hanna Codes yet, go ahead and add one!')); 

		$button1 = $this->modules->get('InputfieldButton'); 
		$button1->attr('id', 'button_add'); 
		$button1->attr('value', $this->_('Add New')); 
		$button1->attr('href', './edit/'); 
		$button1->class .= ' head_button_clone';

		$button2 = $this->modules->get('InputfieldButton'); 
		$button2->attr('id', 'button_import'); 
		$button2->attr('value', $this->_('Import')); 
		$button2->attr('href', './import/'); 
		$button2->class .= ' ui-priority-secondary'; 

		return $table->render() . $button1->render() . $button2->render();
	}	

	public function ___executeImport() {

		$form = $this->modules->get('InputfieldForm'); 

		$f = $this->modules->get('InputfieldTextarea');
		$f->attr('id+name', 'hc_import'); 
		$f->label = $this->_("Paste in Import Data"); 
		$form->add($f); 

		$f = $this->modules->get('InputfieldSubmit');
		$f->attr('name', 'submit_import'); 
		$form->add($f); 

		Wire::setFuel('processHeadline', $this->_("Import Hanna Code")); 

		if(!$this->input->post->submit_import) return $form->render();

		$form->processInput($this->input->post); 
		$data = $form->get('hc_import')->value; 
		if(!preg_match('{!HannaCode:([^:]+):(.*?)/!HannaCode}s', $data, $matches)) throw new WireException("Unrecognized Hanna Code format"); 
		$name = $matches[1]; 
		$data = $matches[2]; 
		$data = base64_decode($data); 
		if($data === false) throw new WireException("Failed to base64 decode import data"); 
		$data = json_decode($data, true); 
		if($data === false) throw new WireException("Failed to json decode import data"); 
		if(empty($data['name']) || empty($data['code'])) throw new WireException("Import data does not contain all required fields"); 

		$result = $this->db->query("SELECT COUNT(*) FROM hanna_code WHERE name='" . $this->db->escape_string($name) . "'"); 
		list($n) = $result->fetch_row(); 
		if($n > 0) {
			$this->error($this->_('Hanna Code with that name already exists')); 
			return $this->session->redirect('../'); 
		}

		$sql = 	"INSERT INTO hanna_code SET " . 
			"`name`='" . $this->db->escape_string($name) . "', " . 
			"`type`=" . ((int) $data['type']) . ", " . 
			"`code`='" . $this->db->escape_string($data['code']) . "', " . 
			"`modified`=" . time();

		if($this->db->query($sql)) {
			$this->message($this->_('Imported Hanna Code:') . " " . wire('sanitizer')->entities($name)); 
			$id = $this->db->insert_id; 
			$this->session->redirect("../edit/?id=$id"); 
		} else {
			throw new WireException("Error importing (database insert)"); 
		}
	}

	/**
	 * Called when the URL is this module's page URL + "/something/"
	 *
	 */
	public function ___executeEdit() {

		// set a new headline, replacing the one used by our page (optional)

		// add a breadcrumb that returns to our main page 
		$this->breadcrumbs->add(new Breadcrumb('../', $this->page->title)); 

		$id = (int) $this->input->get->id; 
		if($id) {
			$result = $this->db->query("SELECT name, type, code FROM hanna_code WHERE id=$id"); 
			if(!$result->num_rows) throw new WireException("Unknown ID"); 
			list($name, $type, $code) = $result->fetch_row();
			$exportData = array('name' => $name, 'type' => $type, 'code' => $code); 
			$attr = '';
			foreach($this->hanna->extractDefaultCodeAttrs($code) as $attrName => $attrValue) {
				$attr .= strlen($attrValue) ? "$attrName=$attrValue\n" : "$attrName\n";
			}

			Wire::setFuel('processHeadline', $this->_("Edit Hanna Code:") . " $name");
		} else {
			$name = '';
			$type = 0;
			$code = '';
			$attr = '';
			$exportData = null;
			Wire::setFuel('processHeadline', $this->_("Adding New Hanna Code")); 
		}

		$form = $this->modules->get('InputfieldForm'); 
		$form->action = './';
		$form->method = 'post';

		$f = $this->modules->get('InputfieldName'); 
		$f->attr('name', 'hc_name'); 
		$f->attr('value', $name); 
		$f->description = $this->_('Any combination of these characters: -_.a-zA-Z0-9 (i.e. letters, numbers, hyphens, underscores, periods, no spaces)');
		$form->add($f); 

		$f = $this->modules->get('InputfieldRadios'); 
		$f->attr('name', 'hc_type'); 
		foreach($this->typeLabels as $key => $label) $f->addOption($key, $label); 
		$f->attr('value', $type & TextformatterHannaCode::TYPE_NOT_CONSUMING ? $type - TextformatterHannaCode::TYPE_NOT_CONSUMING : $type); 
		$f->label = $this->_('Type'); 
		$f->optionColumns = 1; 
		$form->add($f); 

		$f = $this->modules->get('InputfieldMarkup'); 
		$f->label = $this->_('PHP and Javascript Usage Notes'); 
		$f->value = "

		<div class='ui-helper-clearfix'>
			<div class='HannaCodeUsageNote'>
				<h2>PHP Usage Notes</h2>	
				<ol>
				<li>Your code should <code>echo</code> or <code>print</code> the value you want to appear as the replacement for the tag.</li>
				<li>It is not necessary to begin or close your statement with open/close PHP tags. Though you may use them when/if necessary.</li>
				<li>Your code is executed the same way as a ProcessWire template file and all API variables are locally scoped. 
				Meaning, you can call upon <code>\$page</code>, <code>\$pages</code>, or any other API variables. directly.
				See also the PHP Properties section to the right.</li>
				<li>If attributes are specified in the tag (or in the Attributes field on this page), they will appear as locally scoped variables to your PHP code.
				For instance, in the tag <code>[[hello_world first_name=Karena]]</code>, your code will have a <code>\$first_name</code> variable populated with 'Karena'.</li>
				<li>If using attributes, it is optional though recommended that you define defaults in the Attributes field on this screen (even if blank is the default value).</li>
				<li>All attributes are also populated to an <code>\$attr</code> array of [key=value]. For example: <code>\$attr['first_name'] == 'Karena'</code>, in case you find this syntax preferable, or necessary.</li>
				<li>If you use an attribute name that is the same as an API variable name (example: <code>\$page</code>) then the API variable overrides the attribute name. In that case, the attribute value will only be accessible 
				through <code>\$attr</code> (example: <code>\$attr['page']</code>).</li> 
				<li>Your code receives an object named <code>\$hanna</code>. This can be used for getting additional properties, or modifying the larger text value if necessary. See details in the PHP Properties section.</li>
				<li>The <code>\$page</code> API variable available to your Hanna code represents the page where the Hanna code exists. It is possible for this to be different from <code>wire('page')</code>, which represents the page that originated the request.</li>
				<li>These code snippets are written to <code>/site/assets/cache/HannaCode/[tag-name].php</code> and directly executed rather than eval'd.</li>
				</ol>
			</div>

			<div class='HannaCodeUsageNote'>
				<h2>PHP Properties</h2>
				<table class='AdminDataTable'>
				<tr><td><code>\$attr</code></td></td><td>An array of [key=value] attributes passed to your Hanna code.</td></tr>
				<tr><td><code>\$page</code></td></td><td>The page where the Hanna code exists. </td></tr>
				<tr><td><code>\$hanna->name</code></td></td><td>The name (string) of the current Hanna code.</td></tr>
				<tr><td><code>\$hanna->field</code></td></td><td>The Field object representing the text.</td></tr>
				<tr><td><code>\$hanna->value</code></td></td><td>The larger text where the Hanna code lives. This property may also be set.</td></tr>
				</table>
				<p><strong>Please note that \"name\" is a reserved word and may not be used as an attribute name.</strong></p>
				<h2>Javascript Usage Notes</h2>	
				<ol>
				<li>It is not necessary to include <code>&lt;script&gt;</code> tags in your code unless you want to. They will be automatically inserted when not already present.</li>
				<li>If attributes are specified in the tag (or in the attributes section of this page), they will appear as locally scoped variables to your Javascript code.
				For instance, in the tag <code>[[hello_world first_name=Karena]]</code>, your code will have a first_name variable populated with 'Karena'.</li>
				<li>All attributes are also populated to an <code>attr</code> object of <code>attr.key=value</code> (i.e. <code>attr.first_name == 'Karena'</code>), in case you find this syntax preferable.</li>
				<li>If using attributes, it is recommended that you define defaults in the Attributes field on this screen (even if blank is the default value).</li>
				<li>Note that <code>name</code> is a reserved word and may not be used as an attribute name.</li>
				</ol>
			</div>
		</div>

		";

		$f->collapsed = Inputfield::collapsedYes; 
		$form->add($f); 


		$f = $this->modules->get('InputfieldTextarea'); 
		$f->attr('id+name', 'hc_code'); 
		$f->attr('value', $code); 
		$f->label = $this->_('Code'); 
		$f->attr('rows', 20); 
		$f->required = true; 
		$form->add($f); 

		$f = $this->modules->get('InputfieldTextarea'); 
		$f->attr('id+name', 'hc_attr'); 
		$f->attr('value', $attr); 
		$f->label = $this->_('Attributes'); 
		$f->description = $this->_('Optional but recommended if using attributes with PHP or Javascript: Enter one attribute name per line that your Hanna code uses. To specify a default value, enter it as "attr=value". If no default specified, value defaults to a blank string.');
		$f->notes = $this->_('Examples:') . "\nsome_attribute\nattribute_with_default=The Default Value";
		$f->collapsed = Inputfield::collapsedBlank;
		$form->add($f); 

		$yes = $this->_('Yes');
		$no = $this->_('No'); 
		$value = $type & TextformatterHannaCode::TYPE_NOT_CONSUMING ? 1 : 0;
		$f = $this->modules->get('InputfieldRadios'); 
		$f->attr('name', 'hc_not_consuming'); 
		$f->addOption(0, $yes);
		$f->addOption(1, $no);
		$f->attr('value', $value); 
		$f->label = $this->_('Replace surrounding HTML tag?') . ' [' . ($value ? $no : $yes) . ']';
		$f->description = $this->_('Should the output of this Hanna Code replace the immediate surrounding HTML tag if it is the only thing in the tag? If your Hanna Code outputs block-level HTML (like <ul> or <p> tags), this should probably be yes.'); 
		$f->collapsed = Inputfield::collapsedYes; 
		$form->add($f);

		if($exportData) {
			$f = $this->modules->get('InputfieldTextarea');
			$f->attr('id+name', 'hc_export'); 
			$f->attr('value', "!HannaCode:$name:" . base64_encode(json_encode($exportData)) . "/!HannaCode"); 
			$f->label = $this->_('Export'); 
			$f->description = $this->_('To export this Hanna code and import somewhere else, copy the contents of this field and paste into the import box somewhere else.'); 
			$f->notes = $this->_('If you have made any changes above, make sure to save before copying the export data here.'); 
			$f->collapsed = Inputfield::collapsedYes; 
			$form->add($f); 
		}

		if($id) {
			$f = $this->modules->get('InputfieldCheckbox'); 
			$f->attr('name', 'hc_delete'); 
			$f->attr('value', $id); 
			$f->label = $this->_('Delete?'); 
			$f->collapsed = Inputfield::collapsedYes; 
			$form->add($f); 
		}

		$f = $this->modules->get('InputfieldHidden'); 
		$f->attr('name', 'hc_id'); 
		$f->attr('value', $id); 
		$form->add($f); 

		$f = $this->modules->get('InputfieldSubmit'); 
		$f->class .= ' head_button_clone';
		$f->attr('name', 'hc_save'); 
		$f->attr('value', $this->_('Save')); 
		$form->add($f); 

		if($this->input->post->hc_save) $this->save($form); 
	
		return $form->render();	
	}

	/**
	 * Save Hanna code
	 *
	 */
	protected function save($form) {

		if(!$this->input->post->hc_save) return false;

		$id = (int) $this->input->post->hc_id; 
		$delete = (int) $this->input->post->hc_delete; 

		if($delete && $delete === $id) {
			$this->db->query("DELETE FROM hanna_code WHERE id=$delete LIMIT 1"); 	
			$this->message($this->_('Deleted Hanna Code')); 
			$this->session->redirect('../'); 
		}

		$form->processInput($this->input->post); 
		$name = $form->get('hc_name')->value; 
		$type = (int) $form->get('hc_type')->value; 
		$code = $form->get('hc_code')->value; 
		$notc = $form->get('hc_not_consuming')->value; 	
		$attr = $form->get('hc_attr')->value;

		if($attr) {
			// bundle default attr values as PHP code
			$out = '';
			foreach(explode("\n", $attr) as $line) {
				$line = trim($line);
				if(strpos($line, '=')) {
					list($attrName, $attrValue) = explode('=', $line);	
					$attrName = $this->sanitizer->fieldName(trim($attrName));
					$attrValue = '"' . str_replace('"', '\"', $attrValue) . '"';
					$attrValue = str_replace(array('/*', '*/', 'hc_attr'), '', $attrValue); 
				} else {
					$attrName = $line; 
					$attrValue = '""';
				}
				if(empty($attrName)) continue; 
				if(wire($attrName) || in_array($attrName, array('name', 'hanna', 'attr'))) {
					$this->error($this->_('Disallowed attribute name:') . " $attrName");
					$attrName = '_' . $attrName; 
				}
				$out .= "$attrName=$attrValue\n";
			}
			if($out) $code = "/*hc_attr\n{$out}hc_attr*/\n" . $code; 
			unset($out, $attr);
		}

		if($notc) {
			$type = $type | TextformatterHannaCode::TYPE_NOT_CONSUMING; 
		}

		if(empty($name)) {
			$form->get('hc_name')->error('Name is required'); 
			return false;
		}

		if(empty($code)) {
			$form->get('hc_code')->error('Code is required'); 
			return false;
		}

		$sql = 	($id ? "UPDATE " : "INSERT INTO ") . "hanna_code " . 
			"SET " . 
			"`name`='" . $this->db->escape_string($name) . "', " . 
			"`type`=$type, " . 
			"`code`='" . $this->db->escape_string($code) . "', " . 
			"`modified`=" . time() . " " . 
			($id ? "WHERE id=$id" : ""); 

		$result = $this->db->query($sql); 

		if($result) {
			$this->message($this->_("Saved Hanna Code")); 				
			$this->session->redirect("../?sort=-modified"); 
		} else {
			$this->error("Error saving"); 
			return false;
		}
	}

	/**
	 * Called only when your module is installed
	 *
	 * This version creates a new page with this Process module assigned. 
	 *
	 */
	public function ___install() {

		// create the page our module will be assigned to
		$page = new Page();
		$page->template = 'admin';
		$page->name = self::pageName; 

		// installs to the admin "Setup" menu ... change as you see fit
		$page->parent = $this->pages->get($this->config->adminRootPageID)->child('name=setup');
		$page->process = $this; 

		// we will make the page title the same as our module title
		// but you can make it whatever you want
		$info = self::getModuleInfo();
		$page->title = $info['title'];

		// save the page
		$page->save();

		// tell the user we created this page
		$this->message("Created Page: {$page->path}"); 
	}

	/**
	 * Called only when your module is uninstalled
	 *
	 * This should return the site to the same state it was in before the module was installed. 
	 *
	 */
	public function ___uninstall() {

		// find the page we installed, locating it by the process field (which has the module ID)
		// it would probably be sufficient just to locate by name, but this is just to be extra sure.
		$moduleID = $this->modules->getModuleID($this); 
		$page = $this->pages->get("template=admin, process=$moduleID, name=" . self::pageName); 

		if($page->id) {
			// if we found the page, let the user know and delete it
			$this->message("Deleting Page: {$page->path}"); 
			$page->delete();
		}
	}

	
}

